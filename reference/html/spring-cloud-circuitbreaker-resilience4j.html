<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Configuring Resilience4J Circuit Breakers</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	item.on('click', '', content, function(e) {
		$(this).addClass('selected');
		$(this).siblings().removeClass('selected');
		e.data.siblings('.content').addClass('hidden');
		e.data.removeClass('hidden');
	});
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			selectedIndex = $(this).index()
			$(".switch--item").filter(function() { return ($(this).text() === selectedText) }).each(function() {
				$(this).addClass('selected');
				$(this).siblings().removeClass('selected');
				selectedContent = $(this).parent().siblings(".content").eq(selectedIndex)
				selectedContent.removeClass('hidden');
				selectedContent.siblings().addClass('hidden');
			});
		});
	});
}

$(addBlockSwitches);
$(globalSwitch);

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel2">
<li><a href="#_configuring_resilience4j_circuit_breakers">Configuring Resilience4J Circuit Breakers</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect2">
<h3 id="_configuring_resilience4j_circuit_breakers"><a class="link" href="#_configuring_resilience4j_circuit_breakers">Configuring Resilience4J Circuit Breakers</a></h3>
<div class="sect3">
<h4 id="_starters"><a class="link" href="#_starters">Starters</a></h4>
<div class="paragraph">
<p>There are two starters for the Resilience4J implementations, one for reactive applications and one for non-reactive applications.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.cloud:spring-cloud-starter-circuitbreaker-resilience4j</code> - non-reactive applications</p>
</li>
<li>
<p><code>org.springframework.cloud:spring-cloud-starter-circuitbreaker-reactor-resilience4j</code> - reactive applications</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_auto_configuration"><a class="link" href="#_auto_configuration">Auto-Configuration</a></h4>
<div class="paragraph">
<p>You can disable the Resilience4J auto-configuration by setting
<code>spring.cloud.circuitbreaker.resilience4j.enabled</code> to <code>false</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_default_configuration"><a class="link" href="#_default_configuration">Default Configuration</a></h4>
<div class="paragraph">
<p>To provide a default configuration for all of your circuit breakers create a <code>Customize</code> bean that is passed a
<code>Resilience4JCircuitBreakerFactory</code> or <code>ReactiveResilience4JCircuitBreakerFactory</code>.
The <code>configureDefault</code> method can be used to provide a default configuration.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Customizer&lt;Resilience4JCircuitBreakerFactory&gt; defaultCustomizer() {
	return factory -&gt; factory.configureDefault(id -&gt; new Resilience4JConfigBuilder(id)
			.timeLimiterConfig(TimeLimiterConfig.custom().timeoutDuration(Duration.ofSeconds(4)).build())
			.circuitBreakerConfig(CircuitBreakerConfig.ofDefaults())
			.build());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_reactive_example"><a class="link" href="#_reactive_example">Reactive Example</a></h5>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Customizer&lt;ReactiveResilience4JCircuitBreakerFactory&gt; defaultCustomizer() {
	return factory -&gt; factory.configureDefault(id -&gt; new Resilience4JConfigBuilder(id)
			.circuitBreakerConfig(CircuitBreakerConfig.ofDefaults())
			.timeLimiterConfig(TimeLimiterConfig.custom().timeoutDuration(Duration.ofSeconds(4)).build()).build());
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_specific_circuit_breaker_configuration"><a class="link" href="#_specific_circuit_breaker_configuration">Specific Circuit Breaker Configuration</a></h4>
<div class="paragraph">
<p>Similarly to providing a default configuration, you can create a <code>Customize</code> bean this is passed a
<code>Resilience4JCircuitBreakerFactory</code> or <code>ReactiveResilience4JCircuitBreakerFactory</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Customizer&lt;Resilience4JCircuitBreakerFactory&gt; slowCustomizer() {
	return factory -&gt; factory.configure(builder -&gt; builder.circuitBreakerConfig(CircuitBreakerConfig.ofDefaults())
			.timeLimiterConfig(TimeLimiterConfig.custom().timeoutDuration(Duration.ofSeconds(2)).build()), "slow");
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In addition to configuring the circuit breaker that is created you can also customize the circuit breaker after it has been created but before it is returned to the caller.
To do this you can use the <code>addCircuitBreakerCustomizer</code>
method.
This can be useful for adding event handlers to Resilience4J circuit breakers.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Customizer&lt;Resilience4JCircuitBreakerFactory&gt; slowCustomizer() {
	return factory -&gt; factory.addCircuitBreakerCustomizer(circuitBreaker -&gt; circuitBreaker.getEventPublisher()
	.onError(normalFluxErrorConsumer).onSuccess(normalFluxSuccessConsumer), "normalflux");
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_reactive_example_2"><a class="link" href="#_reactive_example_2">Reactive Example</a></h5>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Customizer&lt;ReactiveResilience4JCircuitBreakerFactory&gt; slowCusomtizer() {
	return factory -&gt; {
		factory.configure(builder -&gt; builder
		.timeLimiterConfig(TimeLimiterConfig.custom().timeoutDuration(Duration.ofSeconds(2)).build())
		.circuitBreakerConfig(CircuitBreakerConfig.ofDefaults()), "slow", "slowflux");
		factory.addCircuitBreakerCustomizer(circuitBreaker -&gt; circuitBreaker.getEventPublisher()
        	.onError(normalFluxErrorConsumer).onSuccess(normalFluxSuccessConsumer), "normalflux");
     };
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_collecting_metrics"><a class="link" href="#_collecting_metrics">Collecting Metrics</a></h4>
<div class="paragraph">
<p>Spring Cloud Circuit Breaker Resilience4j includes auto-configuration to setup metrics collection as long as the right
dependencies are on the classpath.  To enable metric collection you must include <code>org.springframework.boot:spring-boot-starter-actuator</code>, and <code>io.github.resilience4j:resilience4j-micrometer</code>.  For more information on the metrics that
get produced when these dependencies are present, see the <a href="https://resilience4j.readme.io/docs/micrometer">Resilience4j documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You don&#8217;t have to include <code>micrometer-core</code> directly as it is brought in by <code>spring-boot-starter-actuator</code>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
<link rel="stylesheet" href="js/highlight/styles/github.min.css">
<script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>